   <!--<link href='//fonts.googleapis.com/css?family=RobotoDraft:regular,bold,italic,thin,light,bolditalic,black,medium&lang=en' rel='stylesheet' type='text/css'>-->
<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/socket-io/socket-io.html">

<link rel="import" href="components/core-iconset-svg/core-iconset-svg.html">
<link rel="import" href="components/core-icons/core-icons.html">
<link rel="import" href="components/core-icons/device-icons.html">
<link rel="import" href="components/core-icons/hardware-icons.html">
<link rel="import" href="components/core-icons/image-icons.html">


<link rel="import" href="components/core-pages/core-pages.html">
<link rel="import" href="components/core-header-panel/core-header-panel.html">
<link rel="import" href="components/core-selector/core-selector.html">
<link rel="import" href="components/core-tooltip/core-tooltip.html">
<link rel="import" href="components/core-toolbar/core-toolbar.html">


<link rel="import" href="components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="components/paper-item/paper-item.html">
<link rel="import" href="components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="components/paper-toast/paper-toast.html">

<link rel="import" href="components/paper-input/paper-input.html">
<link rel="import" href="components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="components/paper-tabs/paper-tabs.html">

<link rel="import" href="components/paper-dialog/paper-dialog-transition.html">
<link rel="import" href="components/paper-dialog/paper-dialog.html" >

<link rel="import" href="components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="components/paper-slider/paper-slider.html">

<link rel="import" href="components/three-js/three-js.html">
<link rel="import" href="components/three-js-helpers/axis-helper.html">
<link rel="import" href="components/three-js-helpers/grid-helper.html">
<link rel="import" href="components/three-js-helpers/shadow-plane.html">
<link rel="import" href="components/three-js-helpers/mirror-plane.html">


<link rel="import" href="scanner-wrapper.html">
<link rel="import" href="calibration-view.html">
<link rel="import" href="settings-view.html">

<polymer-element name="simple-scan">
        <template>
            <link href="./simple-scan.css" rel="stylesheet" ></link>
            <core-header-panel flex mode="seamed">
              <core-toolbar>
                <!--<paper-icon-button icon="menu"></paper-icon-button>-->
                <span flex>Simple-scan</span>
                <input type="button" on-tap="{{connect}}" value="Connect" > </input>
                <input type="button" on-tap="{{save}}" value="Save" > </input>
                
                <!-- TODO: replace these -->
                <span flex><template if="{{!scanner2.connected}}">Please connect the scanner</template></span>
                <span flex><template if="{{scanner2.scanning}}">Scan in progress...</template></span>
                <span flex><template if="{{scanTime!=0}}">Scan took {{scanTime/60}} mins </template></span>

                <core-selector selected="0" id="menuItems">
                  <core-tooltip label="Start scan">
                    <paper-icon-button icon="image:timelapse" on-tap="{{startScan}}" 
                    disabled?="{{scanner2.scanning || !scanner2.connected}}"></paper-icon-button>
                  </core-tooltip>
                  <core-tooltip label="Calibrate">
                    <paper-icon-button icon="image:auto-fix" on-tap="{{showCalibration}}" ></paper-icon-button>
                  </core-tooltip>
                  <core-tooltip label="Settings">
                    <paper-icon-button icon="settings"></paper-icon-button>
                  </core-tooltip>
                  <core-tooltip label="Save scan">
                    <paper-icon-button icon="file-download" disabled></paper-icon-button>
                  </core-tooltip>
                </core-selector>
                
                <paper-menu-button icon="device:usb" disabled?="{{!scanner2.connected}}" halign="right" valign="top">
                    <template repeat="{{port in scanner2.serialPorts}}">
                      <paper-item value="{{port.comName}}" label="{{port.comName}}"></paper-item>
                    </template>
                </paper-menu-button>
               <paper-menu-button icon="more-vert" halign="right" valign="top">
                  <paper-item icon="drive-keep" label="Menu Item 1"></paper-item>
                  <paper-item icon="help"label="Help"></paper-item>
                  <paper-item icon="about"label="About"></paper-item>
                </paper-menu-button>

              </core-toolbar>
              <div class="content" fit>
                <three-js id="threeJs">
                  <three-stats id="stats" show=false></three-stats>
                  <tween-js></tween-js>
                  <three-js-scene name="main" active pickable>
                    <three-directionalLight color="0xffdddd" castShadow shadowDarkness="0.4" pos="[500,200,300]"> </three-directionalLight>
                    <three-ambientLight color="0xffffff" intensity="0.5"> </three-ambientLight>
                    <shadow-plane up=[0,1,0]> </shadow-plane>
                    <mirror-plane up=[0,1,0] resolution=512> </mirror-plane>
                  </three-js-scene>
                  <three-js-scene name="helpers" active>
                      <axis-helper> </axis-helper>
                      <grid-helper up=[0,1,0]> </grid-helper>
                  </three-js-scene>
                  <three-js-viewport name="perspective" id="perspectiveView" class="perspectiveView">
                    <three-js-combinedCamera pos="[200,200,100]" orientation="diagonal" up=[0,1,0]></three-js-combinedCamera>
                    <three-js-orbitControls cameraUp=[0,1,0] autoRotate="{{autoRotate}}" autoRotateSpeed="10"> </three-js-orbitControls>
                  </three-js-viewport>
                </three-js>


                <core-pages class="controls" selected="{{$.menuItems.selected}}" >
                  <div id="scanning"></div>
                  <calibration-view> </calibration-view>
                  <settings-view>    </settings-view>
                </core-pages>
              </div>
            </core-header-panel>
            
            <paper-toast id="toast2" role="alert" text="Connection timed out. Showing limited messages." style="color:black;background: #4285f4;">
              <div style="color: #eeff41;" onclick="console.log('RETRY')">Retry</div>
            </paper-toast>

            <paper-toast id="toast" role="alert" text="{{userToastMessage}}" style="color:black;background: #4285f4;">
              <div style="color: #eeff41;" onclick="console.log('RETRY')">Retry</div>
            </paper-toast>
            
            <paper-dialog heading="Dialog" transition="paper-dialog-transition-center" id="foo">
              <paper-button label="More Info..." dismissive></paper-button>
              <paper-button label="Decline" affirmative></paper-button>
              <paper-button label="Accept" affirmative autofocus></paper-button>
            </paper-dialog>

            <scanner-wrapper id="scannerWrapper"
            calibImageBase="{{calibImageBase}}" calibImageDebug="{{calibImageDebug}}" pointCloudData="{{pointCloudData}}" on-modelchanged="{{fooBar}}">
            </scanner-wrapper>
        </template>
        <script>
            Polymer("simple-scan", {
                laserToggled:false,
                laserDetected:false,
                stepperToggled:false,
                debugToggled  :false,
                //
                laserAngle:0,
                stepsToRotate:10,
                angleToRotate:10,
                _stepsPerRevo:400,//how many steps per full rotation

                scanQual:45,
                scanQualVert:2,
                scanData:null,
                pointCloud:null,
                scanTime:0,

                //
                colorsToggled:false,
                //
                userToastMessage:"Disconnected from socket.io server!",

                //shadowing of "server side" structure
                scanner : null,

                //notification etc
                notificationMessage : "",
                //FIXME: no too sure about these
                scanner2:null,
                calibImageBase:null,
                calibImageDebug:null,
                pointCloudData :null,
                
                fooBar:function(){
                  console.log("GNApointCloudDataChanged");
                  this.drawPointCloud( this.scanner2.pointCloudData );
                },

                created:function(){
                  this.scanner= {
                    vision:{},
                    laser:{},
                    turnTable:{},
                    camera:{},
                    vision:{}
                  };

                  this.scanner.vision.lineExtractionParams = {
                     gaussBlurKernel : [15,15],
                     threshold       : 22,
                     erosion         : 2,
                     dilation        : 5,
                     outThreshold    : 250,
                     maxDist         : 40
                  };
                },
                attached:function(){
                
                  this.scanner2 = this.$.scannerWrapper;
                },
                domReady:function(){
                  this.triDViewer = this.$.threeJs;

    
                  //draw Turntable
                  var radius   = 75,
                      segments = 64,
                      material = new THREE.LineBasicMaterial( { color: 0x000000 } ),
                      geometry = new THREE.CircleGeometry( radius, segments );
                  geometry.vertices.shift();
                  var turnTable = new THREE.Line( geometry, material );
                  turnTable.rotation.set(Math.PI/2,0,0)
                  this.triDViewer.addToScene( turnTable, "helpers"  );

                  /*
                  var geometry = new THREE.BoxGeometry( 50, 50, 50 );
                  var material = new THREE.MeshLambertMaterial( { color: 0xdddddd, shading: THREE.FlatShading } ) ;//new THREE.MeshBasicMaterial( {color: 0xffff00} );
                  var cube = new THREE.Mesh( geometry, material );
  
                  cube.castShadow = true;
                  cube.receiveShadow = false;
                  cube.position.set( 0, 24,0);

                  this.triDViewer.addToScene( cube);*/
                },
                showToast:function(){
                  this.$.toast2.show();
                  this.$.foo.toggle();
                },
                //attribute change handlers
                laserToggledChanged:function()
                {
                    console.log("laser is", this.laserToggled);
                    this.scanner2.toggleLaser(this.laserToggled);
                },
                stepperToggledChanged:function()
                {
                    console.log("stepper is", this.stepperToggled);
                    this.scanner2.toggleTurnTable(this.stepperToggled);
                },
                stepsToRotateChanged:function(){
                    this.sendMessage({event:"stepsToRotate",data:this.stepsToRotate});
                    //update angle accordingly
                    var converted = this.stepsToRotate/this._stepsPerRevo*360; //stepsPerRevo == 360
                    if(converted != this.angleToRotate) this.angleToRotate = converted;
                },
                angleToRotateChanged:function(){
                    this.sendMessage({event:"angleToRotate",data:this.angleToRotate});
                    var converted = this.angleToRotate*this._stepsPerRevo/360; 
                    if(converted != this.stepsToRotate) this.stepsToRotate = converted;
                },
                colorsToggledChanged:function(){
                  //this.pointCloud.material = this.
                },
                calibViewChanged:function(){
                  console.log("calibView",this.calibView);
                  var calibView = this.calibView;
                },
                calibImageDebugChanged:function(){
                  console.log("calibImageDebugChanged");
                  var debugImg = this.calibImageDebug;
                  
                  var canvas2 = this.$.calibCamDebug ;
                  var ctx2 = canvas2.getContext('2d');

                  var uint8Arr = new Uint8Array(debugImg);//.buffer);
                  var str = String.fromCharCode.apply(null, uint8Arr);
                  var base64String = btoa(str);

                  var img = new Image();
                  img.onload = function() {
                      var x = 0;
                      var y = 0;
                      ctx2.drawImage(this, x, y);
                  }
                  img.src = 'data:image/png;base64,' + base64String;
                },
                calibImageBaseChanged:function(){
                  console.log("calibImageBaseChanged");
                  var rawImg = this.calibImageBase;
                  
                                    //draw main image with calibration lines
                  var canvas = this.$.calibCam ;
                  var ctx = canvas.getContext('2d');

                  var uint8Arr = new Uint8Array(rawImg);//.buffer);
                  var str = String.fromCharCode.apply(null, uint8Arr);
                  var base64String = btoa(str);

                  var img = new Image();
                  img.onload = function() {
                      var x = 0;
                      var y = 0;
                      ctx.drawImage(this, x, y);
                  }
                  img.src = 'data:image/png;base64,' + base64String;
                },
                pointCloudDataChanged:function(){
                  console.log("pointCloudDataChanged in change handler");
                  this.drawPointCloud( this.pointCloudData );
                },
                drawPointCloud:function(data){
                  if(!(data)) return;
                  if(this.pointCloud) this.triDViewer.removeFromScene(this.pointCloud);

                  //var data = {positions:[0,0,0,10,10,10,30,30,30],colors:[1,0,0,0,0,1,0,1,0]};
                  /*for(var i = 0; i<data.colors.length;i++)
                  {
                    data.colors[i] = 0;
                  }*/
                  var pos = data.positions;
                  var col = data.colors;

                  //generate
                  var points = data.positions.length/3;
                  var positions = new Float32Array( points* 3  ); 
	                var colors    = new Float32Array( points* 3  );

	                positions.set( pos );
	                colors.set( col );

                  var geometry = new THREE.BufferGeometry();
                  geometry.addAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
				          geometry.addAttribute( 'color', new THREE.BufferAttribute( colors, 3 ) );

                  geometry.computeVertexNormals();
                  geometry.applyMatrix(new THREE.Matrix4().makeScale( 10, 10, 10 ) );

                  var particleSize = 1;//0.2
                  var material = new THREE.PointCloudMaterial({ size: particleSize,vertexColors: THREE.VertexColors});
                  var particles = new THREE.PointCloud( geometry, material );
                  
                  this.triDViewer.addToScene( particles );
                  console.log("HERE", particles);
                  this.pointCloud = particles;
                  
                },
                //public api
                connect:function(){
                  this.scanner2.connect();
                },
                rotateCW:function()
                {
                  this.scanner2.rotateTurnTable(this.angleToRotate);
                },
                rotateCCW:function()
                {
                  this.scanner2.rotateTurnTable(this.angleToRotate);
                },
                startScan:function()
                {
                    console.log("starting Scan");
                    this.scanner2.scan({debug:this.debugToggled,stepDegrees:this.scanQual,vDpi:this.scanQualVert});

                    this.notificationMessage = "Scan in progress...";
                    this.scanData = {positions:[],colors:[]};
                    this._scanStart = new Date().getTime();
                    this.scanTime = 0;
                },
                detectLaser:function(){
                    console.log("detectLaser");
                    this.laserDetected=false;
                    this.scanner2.detectLaser();
                },
                calibrate:function(){
                  console.log("starting calibration");
                  this.scanner2.calibrate(this.calibNewCaptureToggled,this.scanner.vision.lineExtractionParams);
                },
                save:function(){
                  console.log("saving stuff");
                  this.scanner2.save();
                },
            });
        </script>
     </polymer-element>
